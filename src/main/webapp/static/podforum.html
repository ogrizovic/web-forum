<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/forum/css/index.css"> -->
<link rel="stylesheet" href="/forum/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/forum/css/podforum.css">
<script src="/forum/js/jquery-3.2.1.min.js"></script>
<script src="/forum/js/bootstrap.min.js"></script>
<title>Podforum</title>
</head>
<body>
	<ul>
		<li><a href="/forum/static/index.html">Home</a></li>
	</ul>
	<div id="div-sve-teme">
		<h2 id="header-sve-teme"></h2>
		<br/>

		<label>Filter:</label>
		<ul>
			<li>
				<label>Naslov</label>
				<input type="text" id="s_naslov" class="search" />
			</li>
			<li>
				<label>Sadrzaj</label>
				<input type="text" id="s_sadrzaj" class="search" />
			</li>
			<li>
				<label>Autor</label>
				<input type="text" id="s_autor" class="search" />
			</li>
			<li>
				<label>Tip teme</label>
				<input type="text" id="s_tip" class="search" />
			</li>
			<li>
				<button type="button" id="btn-reset-filters">Reset filter</button>
			</li>
		</ul>

		<br/>
		<button type="button" class="user" id="btn-prati">Prati podforum</button>
		<br/>
		<table id="table-teme" class="table-teme-class selectable">
			<tr>
				<th>Naslov</th>
				<th>Tip teme</th>
				<th>Autor</th>
				<th>Datum kreiranja</th>
			</tr>
		</table>
		<!-- Modal buttons -->
		<button type="button" class="user admin moderator" data-toggle="modal" data-target="#modal-nova-tema" id="nova-tema">Nova tema</button>
		<button type="button" class="user moderator admin hide" data-toggle="modal" data-target="#modal-izmena-tema" id="btn-izmena-tema">Izmena</button>
		<button type="button" class="user moderator admin hide" data-toggle="modal" data-target="#modal-brisanje-tema" id="btn-brisanje-tema">Brisanje</button>
	</div>
	<br>
	<div id="div-tema" class="prazna-tabela">
		<table id="table-tema" class="table-tema-class">
			
		</table>
	</div>
	<br>
	<div id="div-komentari">
		<table id="table-komentari" class="table-komentari-class">
			
		</table>
	</div>

<!-- Nova tema modal -->
<!-- Modal -->
<div id="modal-nova-tema" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<h4 class="modal-title">Nova tema</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
	      <table class="modal-table">
	        <form id="form-nova-tema">
	        	<tr>
	        		<td>
		        		<label>Naslov:</label>
		        	</td>
		        	<td>
		        		<input type="text" name="naslov" id="nova-naslov">
		        	</td>
	        	</tr>
	        	<tr>
	        		<td>
		        		<label>Tip teme:</label>
		        	</td>
		        	<td>
		        		<input type="radio" name="tipTeme" value="TEKST" id="radio-tekst" checked>Tekst<br>
		        		<input type="radio" name="tipTeme" value="SLIKA" id="radio-slika">Slika<br>
		        		<input type="radio" name="tipTeme" value="LINK">Link
		        	</td>
	        	</tr>
	        	<tr>
	        		<td>
		        		<label>Sadrzaj:</label>
		        	</td>
		        	<td>
		        		<textarea rows='5' cols='35' name="sadrzaj" id="nova-sadrzaj"></textarea>
		        		<input type="file" name="file" id="nova-sadrzaj-slika" class="hide" accept=".jpg, .jpeg, .png"/>
		        	</td>
	        	</tr>
	        </form>
	       </table>
      </div>
      <div class="modal-footer">
      	<button type="button" class="btn btn-success" data-dismiss="modal" id="btn-dodaj-tema">Dodaj</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Zatvori</button>
      </div>
    </div>

  </div>
</div>

<!-- Izmena tema modal-->

<div id="modal-izmena-tema" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<h4 class="modal-title">Izmena Teme</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
	      <table class="modal-table">
	        <form id="form-izmena-tema">
	        	<tr>
	        		<td>
		        		<label>Naslov:</label>
		        	</td>
		        	<td>
		        		<input type="text" name="naslov" id="izmena-naslov">
		        	</td>
	        	</tr>
	        	<tr>
	        		<td>
		        		<label>Tip teme:</label>
		        	</td>
		        	<td>
		        		<input type="radio" name="tipTeme" value="TEKST">Tekst<br>
		        		<input type="radio" name="tipTeme" value="SLIKA">Slika<br>
		        		<input type="radio" name="tipTeme" value="LINK">Link
		        	</td>
	        	</tr>
	        	<tr>
	        		<td>
		        		<label>Sadrzaj:</label>
		        	</td>
		        	<td>
		        		<textarea rows='5' cols='35' name="sadrzaj" id="izmena-sadrzaj"></textarea>
		        	</td>
	        	</tr>
	        </form>
	       </table>
      </div>
      <div class="modal-footer">
      	<button type="button" class="btn btn-success" data-dismiss="modal" id="btn-izmeni-tema">Izmeni</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Zatvori</button>
      </div>
    </div>

  </div>
</div>


<!-- Izmena tema modal -->
<!-- Modal -->
<div id="modal-brisanje-tema" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
      	<h4 class="modal-title">Brisanje teme</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
	      <p>Da li ste sigurni?</p>
      </div>
      <div class="modal-footer">
      	<button type="button" class="btn btn-success" data-dismiss="modal" id="btn-brisi-tema">Brisi</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Zatvori</button>
      </div>
    </div>

  </div>
</div>

</body>

<script type="text/javascript">
$(document).ready(function(e){
	var podforumId = location.search.substr(1);
	var idIzabraneTeme;
	var idSelektovaneTeme;

	checkIfLoggedIn();
	loadSveTeme();
	// search();

	$("#btn-reset-filters").on("click", function(e){
		loadSveTeme();
		$("#s_naslov").val("");
		$("#s_sadrzaj").val("");
		$("#s_autor").val("");
		$("#s_podforum").val("");
		$("#s_tip").val("");
	})

	$(".search").on("keyup change", function(e){
		search();
	});

	function search() {
		$("#table-teme").find("tr").remove();
		var s_naslov = $("#s_naslov").val();
		var s_sadrzaj = $("#s_sadrzaj").val();
		var s_autor = $("#s_autor").val();
		var s_podforum = $("#s_podforum").val();
		var s_tip = $("#s_tip").val();

		$.get("http://localhost:8080/forum/webapi/search", {s_naslov, s_sadrzaj, s_autor, s_tip}, function(data){
			console.log(data);
			for (var i = 0; i < data.length; i++) {
				$("#table-teme").append("<tr><td style='display:none'>" + data[i].id + "</td><td><a href='#' >" + data[i].naslov + "</a></td><td>" + data[i].tipTeme + "</td><td>" + data[i].autor + "</td><td>" + data[i].datumKreiranja + "</td></tr>");
			}
		});
	}

	$("#modal-nova-tema").on("shown.bs.modal", function(data){
	
		$("#radio-slika").on("click", function(data){
			$("#nova-sadrzaj").addClass("hide");
			$("#nova-sadrzaj-slika").removeClass("hide");
		});
		
		$("#radio-tekst").on("click", function(data){
			$("#nova-sadrzaj").removeClass("hide");
			$("#nova-sadrzaj-slika").addClass("hide");

		});
	});

	$("body").on("click", ".like-tema", function(e){

		var idLajkovaneTeme = $(this).parent().parent().siblings(":first").children(":first").text();

		$.ajax({
			headers:{
				"Authorization": "Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idIzabraneTeme + "/vote?v=like",
			dataType:"json"
		})
		.done(function(){

		})
		.fail(function(jqXHR){
			if (jqXHR.status == 401) {
				alert("Niste prijavljeni.")
			} else {
				alert("error");
				console.log(jqXHR);
			}
		});
	});

	$("body").on("click", ".dislike-tema", function(e){
		var idLajkovaneTeme = $(this).parent().parent().siblings(":first").children(":first").text();

		$.ajax({
			headers:{
				"Authorization": "Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idIzabraneTeme + "/vote?v=dislike",
			dataType:"json"
		})
		.done(function(){

		})
		.fail(function(jqXHR){
			if (jqXHR.status == 401) {
				alert("Niste prijavljeni.")
			} else {
				alert("error");
				console.log(jqXHR);
			}

		});
	});

	$("#btn-prati").on("click", function(e){
		$.ajax({
			headers:{
				"Authorization": "Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/users/" + sessionStorage.getItem("username") + "/prati?podforumId" + podforumId,
			dataType:"json"
		})
		.fail(function(jqXHR){
			if (jqXHR.status == 401) {
				alert("Niste prijavljeni.")
			} else {
				alert("error");
				console.log(jqXHR);
			}

		});
	});

	$("#btn-brisi-tema").on("click", function(e){
		$.ajax({
			headers:{
				"Authorization": "Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"DELETE",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idSelektovaneTeme
		})
		.done(function(data){
			loadSveTeme();
		})
		.fail(function(jqXHR){
			alert("error");
			console.log(jqXHR);
		});
	})

	$("#btn-izmeni-tema").on("click", function(e){
		var tema = {
			naslov: $("#nova-naslov").val(),
			tipTeme: $('input[name=tipTeme]:checked').val(),
			sadrzaj: $("#nova-sadrzaj").val()
		}

		$.ajax({
			headers:{
				"Authorization":"Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"PUT",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idSelektovaneTeme,
			dataType:"json",
			data: JSON.stringify(tema)

		})
		.done(function(data){
			// $("#table-teme").append("<tr><td style='display:none'>" + data.id + "</td><td><a href='#' >" + data.naslov + "</a></td><td>" + data.tipTeme + "</td><td>" + data.autor + "</td><td>" + data.datumKreiranja + "</td></tr>");
			loadSveTeme();
		})
		.fail(function(jqXHR){
			alert("error");
			console.log(jqXHR);
		});
	});

	// popunjavanje input polja za izmenu
	$("#btn-izmena-tema").on("click", function(e){
		// e.preventDefault();
		if (idSelektovaneTeme === null || idSelektovaneTeme === undefined){
			alert("Ni jedna tema nije selektovana.");
			return;
		}
		$.ajax({
			headers:{
				"Authorization": "Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idSelektovaneTeme,
			dataType:"json"
		})
		.done(function(data, status){
			
			$("#izmena-naslov").val(data.naslov);
			$("input[name=tipTeme]:checked").val(data.opis);
			$("#izmena-sadrzaj").val(data.sadrzaj);
		})
		.fail(function(jqXHR, textStatus){
			alert("error");
			console.log(jqXHR);
		});
	});

	$("#btn-dodaj-tema").on("click", function(e){

		if ($("#radio-tekst").is(":checked")) {
			var tema = {
				naslov: $("#nova-naslov").val(),
				tipTeme: $('input[name=tipTeme]:checked').val(),
				sadrzaj: $("#nova-sadrzaj").val()
			}

			$.ajax({
				headers:{
					"Authorization":"Bearer " + sessionStorage.getItem("token"),
					"Content-Type":"application/json"
				},
				type:"POST",
				url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme",
				dataType:"json",
				data: JSON.stringify(tema)

			})
			.done(function(data){
				$("#table-teme").append("<tr><td style='display:none'>" + data.id + "</td><td><a href='#' >" + data.naslov + "</a></td><td>" + data.tipTeme + "</td><td>" + data.autor + "</td><td>" + data.datumKreiranja + "</td></tr>");
			})
			.fail(function(jqXHR, textStatus){
				if (jqXHR.status == 409) {
					alert("Vec postoji tema sa navedenim imenom.")
				} else {
					if (jqXHR.status == 401) {
						alert("error");
						console.log(jqXHR);
					}
				}
			});

		} else {
			if ($("#radio-slika").is(":checked")) {
				var tema = {
					naslov: $("#nova-naslov").val(),
					tipTeme: $('input[name=tipTeme]:checked').val(),
					sadrzaj: ""
				}

				$.ajax({
					headers:{
						"Authorization":"Bearer " + sessionStorage.getItem("token"),
						"Content-Type":"application/json"
					},
					type:"POST",
					url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme",
					dataType:"json",
					data: JSON.stringify(tema)

				})
				.done(function(data){
					
					var input = $("#nova-sadrzaj-slika").val();
					var fd = new FormData();
					fd.append("file", input);
					
					$.ajax({
						headers:{
							"Authorization":"Bearer " + sessionStorage.getItem("token")
						},
						type:"POST",
						enctype:"multipart/form-data",
						url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + data.id + "/upload",
						data:fd,
						processData:false,
						contentType:false,


					})
					.done(function(data){
						$("#table-teme").append("<tr><td style='display:none'>" + data.id + "</td><td><a href='#' >" + data.naslov + "</a></td><td>" + data.tipTeme + "</td><td>" + data.autor + "</td><td>" + data.datumKreiranja + "</td></tr>");
					})
					.fail(function(jqXHR){
						alert("error");
						console.log(jqXHR);
					});

				})
				.fail(function(jqXHR){
					if (jqXHR.status == 409) {
						alert("Vec postoji tema sa navedenim imenom.")
					} else {
						if (jqXHR.status == 401) {
							alert("Niste prijavljeni.");
							
						} else {
							alert("error");
							console.log(jqXHR);
						}
				}
				});
			}
		}
	});

	$("body").on("click", ".tema-link", function(e){

		idIzabraneTeme = $(this).parent().siblings(":first").text();

		$(".prazna-tabela").removeClass("prazna-tabela");

		$.ajax({
			headers:{
				"Authorization":"Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idIzabraneTeme,
			dataType:"json"
		})
		.done(function(data, status){

			$("#table-tema").find("tr").remove();
			$("#table-komentari").find("tr").remove();

			if (data.tipTeme == "TEKST") {

				$("#table-tema").append("<tr><td rowspan='4' style='display:none;'>" + data.id + "<th colspan='2' class='naslov-tema'>" + data.naslov + "</td></tr><tr><td>Autor: " + data.autor + "</td><td>Kreirana: " + data.datumKreiranja + "</td></tr>" + "<tr><td colspan='2'><textarea cols='45' rows='5' readonly>" + data.sadrzaj + "</textarea></td></tr><tr><td><a href='#' class='like-tema'>Like </a>" + data.likes + "</td><td><a href='#' class='dislike-tema'>Dislike </a>" + data.dislikes + "</td></tr>");

					loadKomentari(idIzabraneTeme);
					
			} else {
				if (data.tipTeme == "SLIKA") {
					console.log(data.sadrzajSlika);
					$("#table-tema").append("<tr><td rowspan='4' style='display:none;'>" + data.id + "<th colspan='2' class='naslov-tema'>" + data.naslov + "</td></tr><tr><td>Autor: " + data.autor + "</td><td>Kreirana: " + data.datumKreiranja + "</td></tr>" + "<tr><td colspan='2'><img id='slika' src='data:image/jpg;base64,"+ data.sadrzajSlika + "'  /></td></tr><tr><td><a href='#' class='like-tema'>Like </a>" + data.likes + "</td><td><a href='#' class='dislike-tema'>Dislike </a>" + data.dislikes + "</td></tr>");

					loadKomentari(idIzabraneTeme);
				}
			}

				// var c = $("#canvas").get(0);
				// var ctx = c.getContext("2d");
				// var img = $("#slika");
				// ctx.drawImage(img, 10, 10);
		})
		.fail(function(jqXHR, textStatus){
			alert("error");
			console.log(jqXHR);
		});
	});

	function loadSveTeme(){

		$("#table-teme").find("tr").remove();
		$.ajax({
			headers:{
				"Authorization":"Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme",
			dataType:"json"
		})
		.done(function(data, status){

			if (data[0] === undefined) {

				$("#header-sve-teme").html("Podforum nema tema.");	

			} else {

				$("#header-sve-teme").html("Teme podforuma: " + data[0].parentPodforum.naziv);
			}
			for (var i = 0; i < data.length; i++) {
				$("#table-teme").append("<tr><td style='display:none;'>" + data[i].id + "</td><td><a href='#' class='tema-link'>" + data[i].naslov + "</a></td><td>" + data[i].tipTeme + "</td><td><a href='/'" + data[i].autor + "</td><td>" + data[i].datumKreiranja + "</td></tr>");
			}
		})
		.fail(function(jqXHR, textStatus){
			alert("error");
			console.log(jqXHR);
		});
	}

	$("body").on("click", "#btn-posalji", function(e){

		var komentar = {
			tekstKomentara: $("#text-komentar").val()
		}

		$.ajax({
			headers:{
				"Authorization":"Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"POST",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + idIzabraneTeme + "/komentari",
			dataType:"json",
			data: JSON.stringify(komentar)

		})
		.done(function(data, status){
			loadKomentari(idIzabraneTeme);
		})
		.fail(function(jqXHR, textStatus){
			alert("error");
			console.log(jqXHR);
		});
	});

	function loadKomentari(temaId){
		$.ajax({
			headers:{
				"Authorization":"Bearer " + sessionStorage.getItem("token"),
				"Content-Type":"application/json"
			},
			type:"GET",
			url:"http://localhost:8080/forum/webapi/podforumi/" + podforumId + "/teme/" + temaId + "/komentari",
			dataType:"json"

		})
		.done(function(data, status){

			$("#table-komentari").find("tr").remove();

			$("#table-komentari").append("<tr><th colspan='4'>Komentari</th></tr>");
			for (var i = 0; i < data.length; i++) {
				$("#table-komentari").append("<tr><td rowspan='2' style='display:none;'>" + data[i].id +"</td><td colspan='4'>" + data[i].tekstKomentara + "</td></tr><tr><td>" + data[i].autor.username + "</td><td>" + data[i].datumKomentara + "</td><td><a href='#' class='like-komentar'>Like </a>" + data[i].likes + "</td><td><a href='#' class='dislike-komentar'>Dislike </a>" + data[i].dislikes + "</td></tr>");  
			}

			loadTextArea();
			
		})
		.fail(function(jqXHR, textStatus){
			alert("error");
			console.log(jqXHR);
		});
	}

	function loadTextArea(){
		$("#table-komentari").append("<tr><td colspan='4'><textarea id='text-komentar' rows='4' cols='45'></textarea></td></tr><tr><td colspan='4'><button id='btn-posalji'>Posalji</button></td></tr>");
	}

	function checkIfLoggedIn(){
		var role = sessionStorage.getItem("role");
		// ako nije ulogovan
		if(sessionStorage.getItem('token') === null || sessionStorage.getItem('token') == "") {
			$('.logged-out').removeClass('hide');
			$('.logged-in').addClass('hide');
		}
		else {
			if (role == "USER") {
				$(".user").removeClass("hide");
			}
			else {
					if (role == "MODERATOR") {
					$(".moderator").removeClass("hide");
				}
				else {
					if (role == "ADMIN") {
						$(".admin").removeClass("hide");
					}
				}
			}
		}
	}

	$(".selectable tbody").on("click", "tr", function(){
		$(".selected").removeClass("selected");
		$(this).addClass("selected");

		idSelektovaneTeme = $(this).find("td").eq(0).html();
		console.log(idSelektovaneTeme);
		
	});
});
</script>
</html>